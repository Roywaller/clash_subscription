name: Fetch Clash Subscription

on:
  schedule:
    - cron: '*/5 * * * *'  # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  watch:
    types: 
      - started  # å½“æœ‰äººstarè¿™ä¸ªä»“åº“æ—¶è§¦å‘

jobs:
  fetch-clash-subscription:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          # ç§»é™¤ç¼“å­˜é…ç½®ï¼Œé¿å…æŸ¥æ‰¾é”æ–‡ä»¶
          
      - name: Create package.json and install dependencies
        run: |
          # ç”Ÿæˆpackage.jsonæ–‡ä»¶
          echo '{"name":"clash-fetcher","version":"1.0.0"}' > package.json
          # å®‰è£…axios
          npm install axios

      - name: Fetch and extract subscription link
        id: extract-link
        run: |
          echo "Fetching README.md..."
          wget -O README.md https://raw.githubusercontent.com/abshare/abshare.github.io/refs/heads/main/README.md || {
            echo "Failed to download README.md"
            exit 1
          }
          
          echo "Extracting subscription link..."
          # 1. æå–åŒ…å«â€œhttps://â€çš„é“¾æŽ¥ï¼ˆé¿å…æ¼æˆªæˆ–å¤šæˆªï¼‰
          # 2. ç”¨sedåˆ é™¤å¯èƒ½å¤šä½™çš„â€œ/â€ï¼ˆå¦‚â€œhttps:///xxxâ€æ”¹ä¸ºâ€œhttps://xxxâ€ï¼‰
          LINK=$(grep -A 5 ">ðŸš€å…è´¹Clashè®¢é˜…é“¾æŽ¥" README.md | grep -Eo 'https://[^ ]+' | head -n 1 | sed 's|https:///|https://|g')
      
          if [ -z "$LINK" ]; then
            echo "Failed to find the subscription link."
            exit 1
          fi
      
          # éªŒè¯é“¾æŽ¥æ ¼å¼ï¼ˆå¿…é¡»åŒ…å«â€œhttps://â€ä¸”æ— å¤šä½™å­—ç¬¦ï¼‰
          if ! echo "$LINK" | grep -q '^https://[a-zA-Z0-9.-]'; then
            echo "Invalid link format: $LINK"
            exit 1
          fi
      
          echo "Found valid link: $LINK"
          echo "LINK=$LINK" >> $GITHUB_ENV
          echo "::set-output name=link::$LINK"

      - name: Download subscription content
        run: |
          node -e "
          const axios = require('axios');
          const fs = require('fs');
          const url = process.env.LINK;
          
          console.log('Downloading from:', url);
          
          // å®Œæ•´çš„æµè§ˆå™¨è¯·æ±‚å¤´ï¼Œæ¨¡æ‹ŸChromeæµè§ˆå™¨
          const headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
            'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
            'Accept-Encoding': 'gzip, deflate, br',
            'Referer': 'https://github.com/', // è¡¥å……æ¥æºé¡µï¼Œé¿å…â€œæ— æ¥æºâ€æ‹¦æˆª
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
            'Sec-Fetch-Dest': 'document',
            'Sec-Fetch-Mode': 'navigate',
            'Sec-Fetch-Site': 'cross-site',
            'Sec-Fetch-User': '?1',
            'Cache-Control': 'max-age=0'
          };
      
          axios.get(url, { 
            responseType: 'text',
            headers: headers,
            timeout: 20000, // å»¶é•¿è¶…æ—¶æ—¶é—´ï¼Œé¿å…CloudflareéªŒè¯è€—æ—¶å¯¼è‡´è¶…æ—¶
            decompress: true // æ”¯æŒgzipè§£åŽ‹ï¼ŒåŒ¹é…æµè§ˆå™¨è¡Œä¸º
          })
            .then(response => {
              console.log('Download success, status code:', response.status);
              let content = response.data;
              
              // æ£€æŸ¥æ˜¯å¦è¢«é‡å®šå‘åˆ°CloudflareéªŒè¯é¡µï¼ˆå¦‚åŒ…å«â€œCloudflareâ€å…³é”®è¯ï¼‰
              if (content.includes('Cloudflare')) {
                console.error('Warning: Content contains Cloudflare verification page');
                fs.writeFileSync('cloudflare_block.html', content); // ä¿å­˜æ‹¦æˆªé¡µï¼Œä¾¿äºŽåŽç»­åˆ†æž
                process.exit(1);
              }
      
              // Base64è§£ç é€»è¾‘ï¼ˆä¿ç•™åŽŸåŠŸèƒ½ï¼‰
              try {
                if (content.trim().length % 4 === 0 && /^[A-Za-z0-9+/=]+$/.test(content.trim())) {
                  content = Buffer.from(content.trim(), 'base64').toString('utf8');
                  console.log('Base64 decoded successfully');
                }
              } catch (e) {
                console.log('Not Base64 content, use original');
              }
      
              fs.writeFileSync('clash_subscription.txt', content);
              console.log('Content saved to clash_subscription.txt');
            })
            .catch(error => {
              console.error('Download failed:', error.message);
              if (error.response) {
                console.error('Response status:', error.response.status);
                // ä¿å­˜é”™è¯¯å“åº”å†…å®¹ï¼Œä¾¿äºŽåˆ†æžCloudflareæ‹¦æˆªåŽŸå› 
                fs.writeFileSync('error_response.html', error.response.data);
              }
              process.exit(1);
            });
          "          
        env:
          LINK: ${{ env.LINK }}

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet clash_subscription.txt; then
            echo "No changes to subscription"
            echo "CHANGED=false" >> $GITHUB_ENV
          else
            echo "Subscription has changed"
            echo "CHANGED=true" >> $GITHUB_ENV
          fi

      - name: Commit and push changes
        if: env.CHANGED == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add clash_subscription.txt
          git commit -m "Update clash subscription at $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push "https://${{ secrets.MY_PERSONAL_ACCESS_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main
        env:
          MY_PERSONAL_ACCESS_TOKEN: ${{ secrets.MY_PERSONAL_ACCESS_TOKEN }}
